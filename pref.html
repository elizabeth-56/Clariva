<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLARIVA - Dyslexia Friendly Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .slider {
            -webkit-appearance: none; width: 100%; height: 10px; border-radius: 20px;
            background: #f1f5f9; outline: none; transition: background .2s;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 28px; height: 28px;
            border-radius: 50%; background: #2563eb; cursor: pointer; border: 5px solid white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2);
        }

        .animate-in { animation: animateIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes animateIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .drawer-transition { transition: transform 0.5s ease-out; }
        
        #formatted-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .zoom-in { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-[#E6F0FA] h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="p-4 flex items-center justify-between text-slate-800 bg-white shadow-sm border-b border-slate-100 z-10">
        <div class="flex items-center gap-2">
            <h1 class="text-2xl font-black tracking-tighter text-blue-600">CLARIVA</h1>
            <div id="ai-loader" class="hidden">
                <i data-lucide="loader-2" class="animate-spin text-blue-500 w-5 h-5"></i>
            </div>
            <span id="status-msg" class="text-xs font-medium text-slate-400"></span>
        </div>
        <div class="flex gap-4">
            <button id="save-btn" class="flex flex-col items-center gap-0.5 opacity-70 hover:opacity-100 transition-opacity">
                <i data-lucide="download" class="text-slate-600 w-5 h-5"></i>
                <span class="text-[10px] uppercase font-black">Save</span>
            </button>
            <button id="share-btn" class="flex flex-col items-center gap-0.5 opacity-70 hover:opacity-100 transition-opacity">
                <i data-lucide="share-2" class="text-slate-600 w-5 h-5"></i>
                <span class="text-[10px] uppercase font-black">Share</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden p-4 md:p-6 flex flex-col">
        <div class="max-w-4xl mx-auto w-full flex-1 flex flex-col gap-4 overflow-hidden">
            <div id="text-container" class="flex-1 overflow-y-auto rounded-2xl bg-white/50 backdrop-blur-sm shadow-inner mb-2">
                <div id="formatted-content" class="shadow-sm border border-slate-100 whitespace-pre-wrap flex-1 p-10 min-h-full">
                    <!-- Text rendered here -->
                </div>
            </div>
            <!-- Simplified: Removed Simplify Button container -->
        </div>
    </main>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-[4px] z-40 hidden opacity-0 transition-opacity duration-300"></div>

    <!-- Slide-Up Preference Drawer -->
    <div id="pref-drawer" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[40px] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50 drawer-transition transform translate-y-full overflow-hidden flex flex-col" style="height: 75vh;">
        <div class="w-full flex justify-center p-4 cursor-pointer" id="close-drawer-handle">
            <div class="w-16 h-1.5 bg-slate-200 rounded-full"></div>
        </div>

        <div class="flex px-8 gap-4 mb-8 border-b border-slate-50">
            <button data-tab="settings" class="tab-btn flex items-center gap-2 px-2 py-4 border-b-4 font-black text-xs tracking-widest transition-all border-blue-600 text-blue-600">
                <i data-lucide="type" class="w-4 h-4"></i> SETTINGS
            </button>
            <button data-tab="colors" class="tab-btn flex items-center gap-2 px-2 py-4 border-b-4 font-black text-xs tracking-widest transition-all border-transparent text-slate-400">
                <i data-lucide="palette" class="w-4 h-4"></i> COLORS
            </button>
            <button data-tab="highlights" class="tab-btn flex items-center gap-2 px-2 py-4 border-b-4 font-black text-xs tracking-widest transition-all border-transparent text-slate-400">
                <i data-lucide="highlighter" class="w-4 h-4"></i> HIGHLIGHTS
            </button>
            <button id="reset-btn" class="ml-auto flex items-center gap-2 px-4 py-4 text-red-500 font-black text-xs tracking-widest hover:bg-red-50 rounded-t-2xl transition-all">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> RESET
            </button>
        </div>

        <div id="tab-content" class="flex-1 overflow-y-auto px-10 pb-12 no-scrollbar">
            <!-- Content dynamic based on tab -->
        </div>
    </div>

    <!-- Input Bar -->
    <div class="p-4 bg-white border-t border-slate-200 flex items-center gap-3 z-30 shadow-[0_-10px_30px_rgba(0,0,0,0.03)]">
        <input type="file" id="image-input" class="hidden" accept="image/*">
        <input type="file" id="pdf-input" class="hidden" accept=".pdf">
        
        <div class="flex items-center gap-1 pr-2 border-r border-slate-100 text-slate-300">
            <button id="pdf-trigger" class="p-2.5 hover:bg-slate-50 rounded-xl transition-colors" title="Attach PDF">
                <i data-lucide="file-plus" class="text-blue-500 w-5 h-5"></i>
            </button>
            <button id="camera-trigger" class="p-2.5 hover:bg-slate-50 rounded-xl transition-colors" title="Scan Image">
                <i data-lucide="camera" class="text-blue-500 w-5 h-5"></i>
            </button>
            <button id="gallery-trigger" class="p-2.5 hover:bg-slate-50 rounded-xl transition-colors" title="Gallery">
                <i data-lucide="image" class="text-blue-500 w-5 h-5"></i>
            </button>
        </div>
        
        <input 
            id="text-input"
            type="text" 
            placeholder="Type or scan text..." 
            class="flex-1 bg-slate-50 border border-slate-100 rounded-2xl px-5 py-3.5 focus:outline-none focus:ring-4 focus:ring-blue-50 text-slate-700 transition-all font-medium"
        >

        <div class="flex items-center gap-2 pl-2 border-l border-slate-100">
            <button id="tts-btn" class="p-2.5 text-blue-600 hover:bg-blue-50 rounded-xl transition-colors">
                <i data-lucide="volume-2" class="w-6 h-6"></i>
            </button>
            <button id="talk-trigger" class="p-3 bg-red-500 text-white rounded-2xl shadow-lg hover:bg-red-600 transition-all active:scale-90">
                <i data-lucide="mic" class="w-6 h-6"></i>
            </button>
            <button id="settings-trigger" class="p-3 bg-slate-900 text-white rounded-2xl shadow-lg hover:bg-black transition-all active:scale-90">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Talk Module Modal -->
    <div id="talk-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[110] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-[48px] p-12 max-w-sm w-full text-center shadow-2xl scale-95 opacity-0 transition-all duration-300" id="talk-modal-content">
            <div class="w-28 h-28 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-8 animate-pulse">
                <i data-lucide="mic" class="w-14 h-14"></i>
            </div>
            <h3 class="text-3xl font-black text-slate-900 mb-3">AI TALK</h3>
            <p class="text-slate-500 mb-10 leading-relaxed font-medium">Listening for voice interaction...</p>
            <button id="close-talk-modal" class="w-full py-5 bg-slate-900 text-white rounded-[24px] font-black text-lg tracking-widest shadow-xl">CLOSE</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyDeR294txJ1FMqKinG0ZgvtkYK9OgcGSAQ"; // Environment provides key at runtime

        const DATASET = {
            "font": ["Arial", "Verdana", "Tahoma", "Century Gothic", "Trebuchet MS", "Calibri", "Open Sans", "Comic Sans MS"],
            "font_size": { "min": 12, "recommended": 16, "max": 26 },
            "letter_spacing": { "min": 0.05, "recommended": 0.15, "max": 0.2 },
            "word_spacing": { "min": 0.1, "recommended": 0.25, "max": 0.35 },
            "line_spacing": { "min": 1.4, "recommended": 1.5, "max": 2.0 },
            "background_colors": {
                "soft-cream": "#FFFDD0",
                "off-white": "#FAF9F6",
                "pastel-yellow": "#FEFFD2",
                "light-blue": "#E3F2FD",
                "light-peach": "#FFDAB9"
            },
            "text_colors": {
                "black": "#000000",
                "dark-blue": "#00008B",
                "dark-brown": "#5D4037"
            },
            "highlight_colors": {
                "vowels": "#3b82f6",
                "mirror_letters1": "#2e7d32", 
                "mirror_letters2": "#c62828",
                "similar_shapes1": "#6a1b9a",
                "similar_shapes2": "#1565c0",
                "similar_shapes3": "#ef6c00",
                "thin_vertical1": "#283593",
                "thin_vertical2": "#4527a0",
                "tail_letters": "#00695c",
                "similar_numbers": "#37474f"
            },
            "confusing_letter_groups": {
                "mirror_letters1": ["b", "d"],
                "mirror_letters2": ["p", "q"],
                "similar_shapes1": ["m", "n"],
                "similar_shapes2": ["o", "u"],
                "similar_shapes3": ["c", "e"],
                "thin_vertical1": ["i", "j"],
                "thin_vertical2": ["l", "t"],
                "tail_letters": ["g", "y"],
                "similar_numbers": ["6", "9"]
            }
        };

        const DEFAULT_PREFS = {
            font: "Open Sans",
            font_size: 16,
            line_spacing: 1.5,
            letter_spacing: 0.15,
            word_spacing: 0.25,
            background_color: "soft-cream",
            text_color: "black",
            active_highlights: ["vowel_coloring"],
            active_confusing_groups: [] 
        };

        let preferences = { ...DEFAULT_PREFS };
        let inputText = "CLARIVA--Drop your text here.";
        let activeTab = 'settings';

        // Elements
        const textInput = document.getElementById('text-input');
        const formattedContent = document.getElementById('formatted-content');
        const prefDrawer = document.getElementById('pref-drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const tabContentContainer = document.getElementById('tab-content');
        const talkModal = document.getElementById('talk-modal');
        const talkModalContent = document.getElementById('talk-modal-content');
        const statusSpan = document.getElementById('status-msg');
        const aiLoader = document.getElementById('ai-loader');

        // Initial Icon Render
        lucide.createIcons();

        // Functions
        function renderText() {
            formattedContent.innerHTML = '';
            formattedContent.style.fontFamily = preferences.font;
            formattedContent.style.fontSize = preferences.font_size + 'px';
            formattedContent.style.lineHeight = preferences.line_spacing;
            formattedContent.style.letterSpacing = preferences.letter_spacing + 'em';
            formattedContent.style.wordSpacing = preferences.word_spacing + 'em';
            formattedContent.style.color = DATASET.text_colors[preferences.text_color];
            formattedContent.style.backgroundColor = DATASET.background_colors[preferences.background_color];

            const words = inputText.split(/\s+/);
            words.forEach((word) => {
                if (!word) return;
                const wordSpan = document.createElement('span');
                wordSpan.className = 'inline-block';
                
                word.split('').forEach((char, charIdx) => {
                    const charSpan = document.createElement('span');
                    const lowerChar = char.toLowerCase();
                    charSpan.textContent = char;

                    if (preferences.active_highlights.includes('first_letter_bold') && charIdx === 0) {
                        charSpan.style.fontWeight = '900';
                    }
                    if (preferences.active_highlights.includes('vowel_coloring') && 'aeiou'.includes(lowerChar)) {
                        charSpan.style.color = DATASET.highlight_colors.vowels;
                        charSpan.style.fontWeight = 'bold';
                    }
                    Object.entries(DATASET.confusing_letter_groups).forEach(([groupId, letters]) => {
                        if (preferences.active_confusing_groups.includes(groupId) && letters.includes(lowerChar)) {
                            charSpan.style.color = DATASET.highlight_colors[groupId];
                            charSpan.style.fontWeight = 'bold';
                        }
                    });
                    wordSpan.appendChild(charSpan);
                });
                formattedContent.appendChild(wordSpan);
                formattedContent.appendChild(document.createTextNode(' '));
            });
        }

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                btn.className = `tab-btn flex items-center gap-2 px-2 py-4 border-b-4 font-black text-xs tracking-widest transition-all ${isActive ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400'}`;
            });
            renderTabContent();
        }

        function renderTabContent() {
            tabContentContainer.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-10 animate-in fade-in zoom-in duration-300';

            if (activeTab === 'settings') {
                const fontGrid = document.createElement('div');
                fontGrid.className = 'grid grid-cols-2 gap-3';
                DATASET.font.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = `p-4 rounded-2xl border-2 text-sm text-left transition-all ${preferences.font === f ? 'border-blue-500 bg-blue-50 font-black text-blue-700' : 'border-slate-50 hover:border-slate-200 text-slate-600'}`;
                    btn.textContent = f;
                    btn.onclick = () => { preferences.font = f; renderTabContent(); renderText(); };
                    fontGrid.appendChild(btn);
                });
                wrapper.appendChild(createSection('Font Family', fontGrid));

                const slidersGrid = document.createElement('div');
                slidersGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-10';
                slidersGrid.appendChild(createSlider('Font Size', DATASET.font_size.min, DATASET.font_size.max, 1, preferences.font_size, (v) => { preferences.font_size = v; renderText(); }));
                slidersGrid.appendChild(createSlider('Line Spacing', 1.2, 2.5, 0.1, preferences.line_spacing, (v) => { preferences.line_spacing = v; renderText(); }));
                slidersGrid.appendChild(createSlider('Letter Spacing', 0.05, 0.3, 0.01, preferences.letter_spacing, (v) => { preferences.letter_spacing = v; renderText(); }));
                slidersGrid.appendChild(createSlider('Word Spacing', 0.1, 0.5, 0.01, preferences.word_spacing, (v) => { preferences.word_spacing = v; renderText(); }));
                wrapper.appendChild(slidersGrid);
            } else if (activeTab === 'colors') {
                const bgFlex = document.createElement('div');
                bgFlex.className = 'flex gap-5 flex-wrap';
                Object.entries(DATASET.background_colors).forEach(([name, hex]) => {
                    const btn = document.createElement('button');
                    btn.style.backgroundColor = hex;
                    btn.className = `w-16 h-16 rounded-3xl border-4 transition-all shadow-md ${preferences.background_color === name ? 'border-blue-600 scale-110' : 'border-white'}`;
                    btn.onclick = () => { preferences.background_color = name; renderTabContent(); renderText(); };
                    bgFlex.appendChild(btn);
                });
                wrapper.appendChild(createSection('Background', bgFlex));

                const textFlex = document.createElement('div');
                textFlex.className = 'flex gap-5 flex-wrap';
                Object.entries(DATASET.text_colors).forEach(([name, hex]) => {
                    const btn = document.createElement('button');
                    btn.style.backgroundColor = hex;
                    btn.className = `w-16 h-16 rounded-3xl border-4 transition-all shadow-md ${preferences.text_color === name ? 'border-blue-600 scale-110' : 'border-white'}`;
                    btn.onclick = () => { preferences.text_color = name; renderTabContent(); renderText(); };
                    textFlex.appendChild(btn);
                });
                wrapper.appendChild(createSection('Text Color', textFlex));
            } else if (activeTab === 'highlights') {
                const globalGrid = document.createElement('div');
                globalGrid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';
                [{ id: 'vowel_coloring', label: 'Vowel Coloring' }, { id: 'first_letter_bold', label: 'Bold Starts' }].forEach(mode => {
                    const isActive = preferences.active_highlights.includes(mode.id);
                    const btn = document.createElement('button');
                    btn.className = `p-5 rounded-2xl text-sm font-black border-2 flex items-center justify-between transition-all ${isActive ? 'bg-blue-600 text-white border-blue-400 shadow-xl' : 'bg-slate-50 border-slate-100 text-slate-500'}`;
                    btn.innerHTML = `<span>${mode.label}</span>${isActive ? '<i data-lucide="check" class="w-5 h-5"></i>' : ''}`;
                    btn.onclick = () => {
                        if(isActive) preferences.active_highlights = preferences.active_highlights.filter(i => i !== mode.id);
                        else preferences.active_highlights.push(mode.id);
                        renderTabContent(); renderText();
                    };
                    globalGrid.appendChild(btn);
                });
                wrapper.appendChild(createSection('Global Modes', globalGrid));

                const pairsGrid = document.createElement('div');
                pairsGrid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-3';
                Object.entries(DATASET.confusing_letter_groups).forEach(([groupId, letters]) => {
                    const isActive = preferences.active_confusing_groups.includes(groupId);
                    const btn = document.createElement('button');
                    btn.className = `p-4 rounded-2xl flex items-center justify-center font-mono text-xl font-black shadow-sm border-2 transition-all ${isActive ? 'border-transparent' : 'border-slate-50'}`;
                    btn.style.color = isActive ? 'white' : DATASET.highlight_colors[groupId];
                    btn.style.backgroundColor = isActive ? DATASET.highlight_colors[groupId] : 'white';
                    btn.innerHTML = `${letters.join('')}${isActive ? '<i data-lucide="check" class="ml-2 w-4 h-4"></i>' : ''}`;
                    btn.onclick = () => {
                        if(isActive) preferences.active_confusing_groups = preferences.active_confusing_groups.filter(i => i !== groupId);
                        else preferences.active_confusing_groups.push(groupId);
                        renderTabContent(); renderText();
                    };
                    pairsGrid.appendChild(btn);
                });
                wrapper.appendChild(createSection('Specific Letter Pairs', pairsGrid));
            }

            tabContentContainer.appendChild(wrapper);
            lucide.createIcons();
        }

        function createSection(title, contentEl) {
            const section = document.createElement('section');
            const label = document.createElement('label');
            label.className = 'block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4';
            label.textContent = title;
            section.appendChild(label);
            section.appendChild(contentEl);
            return section;
        }

        function createSlider(title, min, max, step, val, onChange) {
            const container = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4';
            label.textContent = title;
            const input = document.createElement('input');
            input.type = 'range';
            input.min = min;
            input.max = max;
            input.step = step;
            input.value = val;
            input.className = 'slider';
            input.oninput = (e) => onChange(parseFloat(e.target.value));
            container.appendChild(label);
            container.appendChild(input);
            return container;
        }

        function setAiLoading(loading, msg = "") {
            aiLoader.classList.toggle('hidden', !loading);
            statusSpan.textContent = msg;
        }

        // Actions
        document.getElementById('save-btn').onclick = () => {
            const bgColor = DATASET.background_colors[preferences.background_color];
            const textColor = DATASET.text_colors[preferences.text_color];
            const content = formattedContent.innerHTML;

            const htmlContentParts = [
                '<!DOCTYPE html>',
                '<html>',
                '<head>',
                '<title>CLARIVA Document</title>',
                '<style>',
                `body { background-color: ${bgColor}; color: ${textColor}; font-family: '${preferences.font}', sans-serif; font-size: ${preferences.font_size}px; line-height: ${preferences.line_spacing}; letter-spacing: ${preferences.letter_spacing}em; word-spacing: ${preferences.word_spacing}em; padding: 40px; white-space: pre-wrap; margin: 0; }`,
                '</style>',
                '</head>',
                `<body>${content}</body>`,
                '</html>'
            ];
            
            const blob = new Blob([htmlContentParts.join('\n')], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'CLARIVA_Formatted.html';
            link.click();
            statusSpan.textContent = "Saved to Downloads";
            setTimeout(() => statusSpan.textContent = '', 2000);
        };

        document.getElementById('tts-btn').onclick = async () => {
            setAiLoading(true, "Generating voice...");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: inputText }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });
                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                const audio = new Audio(URL.createObjectURL(new Blob([Uint8Array.from(atob(audioData), c => c.charCodeAt(0))], { type: 'audio/wav' })));
                audio.play();
            } finally { setAiLoading(false); }
        };

        // Modal/Drawer logic
        document.getElementById('settings-trigger').onclick = () => {
            drawerOverlay.classList.remove('hidden');
            setTimeout(() => drawerOverlay.classList.remove('opacity-0'), 10);
            prefDrawer.classList.remove('translate-y-full');
        };
        drawerOverlay.onclick = document.getElementById('close-drawer-handle').onclick = () => {
            drawerOverlay.classList.add('opacity-0');
            setTimeout(() => drawerOverlay.classList.add('hidden'), 300);
            prefDrawer.classList.add('translate-y-full');
        };
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => switchTab(btn.dataset.tab);
        });
        document.getElementById('reset-btn').onclick = () => {
            preferences = JSON.parse(JSON.stringify(DEFAULT_PREFS));
            renderTabContent(); renderText();
        };
        textInput.oninput = (e) => {
            inputText = e.target.value || "CLARIVA **";
            renderText();
        };
        document.getElementById('talk-trigger').onclick = () => {
            talkModal.classList.remove('hidden');
            setTimeout(() => talkModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        document.getElementById('close-talk-modal').onclick = () => {
            talkModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => talkModal.classList.add('hidden'), 300);
        };

        // File/Image triggers
        document.getElementById('camera-trigger').onclick = () => document.getElementById('image-input').click();
        document.getElementById('gallery-trigger').onclick = () => document.getElementById('image-input').click();
        document.getElementById('image-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                setAiLoading(true, "Scanning image...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Extract text from this image exactly." },
                                    { inlineData: { mimeType: "image/png", data: ev.target.result.split(',')[1] } }
                                ]
                            }]
                        })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        inputText = text;
                        textInput.value = text;
                        renderText();
                    }
                } finally { setAiLoading(false); }
            };
            reader.readAsDataURL(file);
        };

        // Share
        document.getElementById('share-btn').onclick = () => {
            if(navigator.share) navigator.share({ title: 'CLARIVA', text: inputText });
        };

        // Init
        textInput.value = inputText;
        renderText();
        renderTabContent();

    </script>
</body>
</html>